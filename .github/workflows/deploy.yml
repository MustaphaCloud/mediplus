name: CI/CD Pipeline - Mediplus App

on:
  push:
    branches: [ main ]

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Log in to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, Tag, and Push Docker Image
        run: |
          # registry from secret, sanitize it (remove leading/trailing slashes)
          REGISTRY='${{ secrets.REGISTRY_NAME }}'
          REGISTRY="${REGISTRY#/}"
          REGISTRY="${REGISTRY%/}"

          if [ -z "$REGISTRY" ]; then
            echo "ERROR: secrets.REGISTRY_NAME is empty. Set it to e.g. 123456789012.dkr.ecr.us-east-1.amazonaws.com"
            exit 1
          fi

          REPO='mediplus'    # change to medplux if that's your repo name
          TAG=${{ github.run_number }}
          IMAGE_URI="${REGISTRY}/${REPO}:${TAG}"
          echo "Resolved IMAGE_URI: $IMAGE_URI"

          docker build -t "$IMAGE_URI" .
          docker push "$IMAGE_URI"

  update-k8s-yaml:
    runs-on: ubuntu-latest
    needs: build_and_deploy
    steps:
      - name: Clone kubernetes-manifest repo
        env:
          GIT_USERNAME: ${{ secrets.GIT_USERNAME }}
          GIT_PASSWORD: ${{ secrets.GIT_PASSWORD }}
        run: |
          git clone https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/digitalwitchdemo/kubernetes-manifest.git
          cd kubernetes-manifest/mediplus-yaml

          REGISTRY='${{ secrets.REGISTRY_NAME }}'
          REGISTRY="${REGISTRY#/}"
          REGISTRY="${REGISTRY%/}"
          TAG=${{ github.run_number }}
          NEW_IMAGE="${REGISTRY}/mediplus:${TAG}"

          echo "Replacing image tag in deployment.yaml with: $NEW_IMAGE"
          sed -i "s+696035274327.dkr.ecr.us-east-1.amazonaws.com/mediplus:.*+${NEW_IMAGE}+g" deployment.yaml

          echo "Updated deployment.yaml:"
          sed -n '1,200p' deployment.yaml

          git config user.email "support@digitalwitchng.online"
          git config user.name "${GIT_USERNAME}"
          git add deployment.yaml
          git commit -m "ci: Updated deployment.yaml image tag to ${TAG}" || echo "No changes to commit"
          git push https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/digitalwitchdemo/kubernetes-manifest.git HEAD:main || echo "Push may have failed; check credentials"

